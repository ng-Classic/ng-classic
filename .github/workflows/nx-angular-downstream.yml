---
name: Update Nx Angular
on:
  schedule:
    - cron: 0 * * * *
  push:
    branches:
      - main
      - downstream-nx
jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2
      - name: Configure Git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "GitHub Actions Bot"
      - name: Get Nx repo and filter out angular package
        run: |
          mkdir .tmp && cd .tmp
          git clone https://github.com/nrwl/nx.git && cd nx
          # filter only the angular package
          git filter-branch --force --prune-empty --subdirectory-filter packages/angular master
          cd ../..
          git remote add nx .tmp/nx
      - name: Get updates from Nx repo and merge into ours
        run: |
          git fetch nx master
          git checkout -b tmp/angular-updates FETCH_HEAD
          git checkout main && git pull origin main
          git checkout -b chore/update-nx-angular
          # take files from temporary branch and put them where we need them
          git read-tree --prefix packages/nx/nx-angular-classic -u tmp/angular-updates
      - name: Replace '@angular/' with '@angular-classic/' and push
        run: |
          find packages/nx/nx-angular-classic -type f -exec sed -i 's/@angular\//@angular-classic\//g' {} +
          git push origin chore/update-nx-angular
      - name: Cleanup
        run: |
          git branch -D tmp/angular-updates
          git remote rm nx
          rm -rf .tmp
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: Update Nx Angular
          title: Update Nx Angular
          body: Updates the Nx Angular package to the latest version.
          branch: chore/update-nx-angular
          base: main
          delete-branch: true
